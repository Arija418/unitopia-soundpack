<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Sonntag, Mai 17, 2020, 3:19 PM -->
<!-- MuClient version 5.05 -->

<!-- Plugin "unitopia" generated by Plugin Wizard -->

<muclient>
<plugin
   name="unitopia"
   author="FrankieT, Arija"
   id="32f743256f9d2090ecfef8aa"
   language="Lua"
   purpose="UNItopia MUSHclient Soundpack"
   date_written="2020-05-17 15:18:42"
      save_state="n"
   requires="5.05"
   version="1.0"
   >

</plugin>

<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
</triggers>

<!--  Aliases  -->

<aliases>
</aliases>

<!--  Script  -->

<script>
<![CDATA[
Path = require("pl.path")
ConfigFile = require("ini")
PPI = require("ppi")
Constants = require("unitopia.constants")
Audio = nil

Plugins = {}
Plugins[1] = "LuaAudio.xml"
Plugins[2] = "output_functions.xml"
Plugins[3] = "omit_blank_lines.xml"
Plugins[4] = "channel_history.xml"

SOUND_FOLDER = world.GetInfo(74)

UserConfig = {}
UserConfig.Settings = {}
UserConfig.Settings.ScreenReaderPlugin = "MushReader"
UserConfig.Settings.SoundVolume = 20
UserConfig.Settings.AreaVolume = 15
UserConfig.Settings.MusicVolume = 10
UserConfig.Settings.SoundsMuted = 0
UserConfig.Settings.AreaMuted = 0
UserConfig.Settings.MusicMuted = 0

AreaSoundHandle = 0 -- Holds a reference to the current area sound being played. 0 = no sound is playing.
MusicSoundHandle = 0 -- Holds a reference to the current background music being played. 0 = no music is playing.

function OnPluginInstall()
  LoadDependentPlugins(Plugins)

  if (IsFirstSoundpackStart()) then
    world.Note("Anscheinend wird das Soundpack zum ersten mal gestartet. Generiere benutzerspezivische Einstellungsdatei...")
    SaveUserConfig()
    world.Note("Einstellungsdatei generiert. Viel Spass mit dem UNItopia Soundpack!")
  else
    LoadUserConfig()
  end

  Audio = PPI.load(Constants.Plugins.AUDIO_PLUGIN_ID)

  if (not Audio) then
    error("Fehler beim Initialisieren des Audio Systems")
  end
  InitializeNumPad()
end

function OnPluginDisconnect()
  SaveUserConfig()
end

function LoadDependentPlugins(plugins)
  for i, plugin in pairs(plugins) do
    local pluginPath = world.GetInfo(60).."/"..plugin
    world.LoadPlugin(pluginPath)
  end

  -- Now, load also the TTS plugin
  world.LoadPlugin(world.GetInfo(60).."/"..UserConfig.Settings.ScreenReaderPlugin..".xml")
end

function LoadUserConfig()
  local configTable = ConfigFile.read("settings.dat")

  if (configTable) then
    for name, section in pairs(configTable) do
      for optionName, optionValue in pairs (section) do
        local config = nil
        config = tonumber(optionValue)
        if (config == nil) then
          config = optionValue
        end
        if (UserConfig[name] == nil) then
          UserConfig[name] = {}
        end
        UserConfig[name][optionName] = config
      end
    end
  end
end

function SaveUserConfig()
  ConfigFile.write("settings.dat", UserConfig)
end

function IsFirstSoundpackStart()
  if (not Path.exists("settings.dat")) then 
    return true 
  end
  return false
  end

function PlaySound(sound, volume, panning)
  volume = volume or UserConfig.Settings.SoundVolume
  panning = panning or 0

  if (UserConfig.Settings.SoundMuted == 1) then
    return
  end

  return Audio.play(SOUND_FOLDER.."/"..sound, 0, panning, volume)
end

function PlayLoopedSound(sound, volume, panning)
  volume = volume or UserConfig.Settings.SoundVolume
  panning = panning or 0

  if (UserConfig.Settings.SoundMuted == 1) then
    return
  end

  return Audio.play(SOUND_FOLDER.."/"..sound, 1, panning, volume)
end

function StopSound(soundId)
  if ((tonumber(soundId) ~= nil) and (Audio.isPlaying(soundId) == 1)) then
    Audio.stop(id)
  end
end

function InitializeNumPad()
  world.Accelerator('Numpad1', 'sw')
  world.Accelerator('Numpad2', 's')
  world.Accelerator('Numpad3', 'so')
  world.Accelerator('Numpad4', 'w')
  world.Accelerator('Numpad6', 'o')
  world.Accelerator('Numpad7', 'nw')
  world.Accelerator('Numpad8', 'n')
  world.AcceleratorTo('Numpad9','send_command("no")', sendto.script)
  world.Accelerator('Add', 'r')
  world.Accelerator('Subtract', 'h')
end
]]>
</script>
</muclient>
